<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tri-Sandhya Timings (Date Picker)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SunCalc -->
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                        0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .glow {
            text-shadow: 0 0 5px #f6e0b7, 0 0 10px #fbd38d;
        }
        .responsive-iframe-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-top: 56.25%;
        }
        .responsive-iframe-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100">

<div id="app" class="w-full max-w-lg">
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-orange-700 glow">Tri-Sandhya Timer</h1>
        <p class="text-gray-600 mt-2">Calculate 48-minute periods based on selected date and location.</p>
    </header>

    <!-- Card -->
    <div class="bg-white p-6 rounded-xl mb-6 card border-t-4 border-orange-500">

        <!-- Date Picker -->
        <div class="mb-4">
            <label for="date-input" class="block text-sm font-medium text-gray-700 mb-1">Select Date:</label>
            <input type="date" id="date-input"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"
                   required>
        </div>

        <!-- Location Display -->
        <p class="text-sm text-gray-500 mb-4">
            Location:
            <span id="location-display" class="font-medium text-gray-700">Fetching coordinates...</span>
        </p>

        <!-- Calculate button -->
        <button id="calculate-btn"
                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
            Calculate Timings
        </button>

        <!-- Clear Timings button -->
        <button id="clear-btn"
                class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md">
            Clear Timings
        </button>

    </div>

    <!-- Timings display -->
    <div id="timings-container" class="space-y-4">
        <div id="loading-message"
             class="text-center p-8 bg-yellow-100 text-yellow-800 rounded-xl font-medium">
            Awaiting Geolocation and Date Selection...
        </div>
    </div>

    <!-- Bhajan -->
    <div class="mt-8 pt-6 border-t border-gray-300">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Bhajan for Sandhya</h2>
        <div class="bg-white p-4 rounded-xl card border-b-4 border-red-500">
            <p class="text-sm text-gray-600 mb-3 text-center">
                Shri Ram Jay Ram Jay Jay Ram | Ram Dhun
            </p>
            <div class="responsive-iframe-container rounded-lg overflow-hidden shadow-lg">
                <iframe src="https://www.youtube.com/embed/CbPtM6oeTZU?rel=0"
                        frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Error box -->
    <div id="error-message"
         class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl"
         role="alert">
        <span class="font-bold">Error:</span>
        <span id="error-text"></span>
    </div>
</div>


<script>
/* -----------------------------------
   GLOBAL VARIABLES
----------------------------------- */
let userLat = null;
let userLng = null;

/* ---------- Utility ---------- */
const formatTime = (d) => {
    if (!d || isNaN(d.getTime())) return "N/A";
    return d.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });
};

const getToday = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

/* ---------- Core Calculation ---------- */
const calculateTriSandhya = (date, lat, lng) => {
    const times = SunCalc.getTimes(date, lat, lng);
    const T24 = 24 * 60 * 1000;

    return [
        {
            name: "Pratah Sandhya (Morning)",
            description: "48-minute period centered on Sunrise.",
            icon: "ðŸŒž",
            start: new Date(times.sunrise.getTime() - T24),
            end: new Date(times.sunrise.getTime() + T24)
        },
        {
            name: "Madhyahnikam Sandhya (Noon)",
            description: "48-minute period centered on Solar Noon.",
            icon: "ðŸ”†",
            start: new Date(times.solarNoon.getTime() - T24),
            end: new Date(times.solarNoon.getTime() + T24)
        },
        {
            name: "Saayam Sandhya (Evening)",
            description: "48-minute period centered on Sunset.",
            icon: "ðŸŒ™",
            start: new Date(times.sunset.getTime() - T24),
            end: new Date(times.sunset.getTime() + T24)
        }
    ];
};

/* ---------- Render UI ---------- */
const renderTimings = (arr, date) => {
    const container = document.getElementById("timings-container");
    container.innerHTML = "";

    const head = document.createElement("h3");
    head.className = "text-xl font-bold text-gray-700 p-2 border-b border-gray-300 mb-4";
    head.textContent = "Timings for: " + date.toDateString();
    container.appendChild(head);

    arr.forEach(t => {
        const card = document.createElement("div");
        card.className = "card bg-white p-6 rounded-xl border-l-4 border-orange-400 shadow-md";

        card.innerHTML = `
            <div class="flex items-center mb-2">
                <span class="text-3xl mr-3">${t.icon}</span>
                <h3 class="text-xl font-bold text-orange-600">${t.name}</h3>
            </div>
            <p class="text-sm text-gray-500 mb-3">${t.description}</p>
            <div class="space-y-2">
                <div class="flex justify-between text-gray-800">
                    <span class="font-medium">Start Time:</span>
                    <span class="font-extrabold text-green-600">${formatTime(t.start)}</span>
                </div>
                <div class="flex justify-between text-gray-800">
                    <span class="font-medium">End Time:</span>
                    <span class="font-extrabold text-red-600">${formatTime(t.end)}</span>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
};

/* ---------- Error ---------- */
const displayError = (msg) => {
    const e = document.getElementById("error-message");
    document.getElementById("error-text").textContent = msg;
    e.classList.remove("hidden");
};

/* ---------- Clearing ---------- */
const clearTimings = () => {
    document.getElementById("timings-container").innerHTML = `
        <div id="loading-message"
             class="text-center p-8 bg-yellow-100 text-yellow-800 rounded-xl font-medium">
            Awaiting Geolocation and Date Selection...
        </div>`;
    document.getElementById("error-message").classList.add("hidden");
};

/* ---------- Main Calculation Handler ---------- */
const handleCalc = () => {
    if (!userLat || !userLng) {
        displayError("Location not available yet.");
        return;
    }

    const d = document.getElementById("date-input").value;
    if (!d) return displayError("Please select a valid date.");

    const dateObj = new Date(d + "T00:00:00");

    try {
        const t = calculateTriSandhya(dateObj, userLat, userLng);
        renderTimings(t, dateObj);
    } catch (err) {
        displayError("Unable to calculate timings for this date.");
    }
};

/* ---------- INIT ---------- */
window.onload = () => {
    document.getElementById("date-input").value = getToday();

    document.getElementById("calculate-btn").addEventListener("click", handleCalc);
    document.getElementById("clear-btn").addEventListener("click", clearTimings);

    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                userLat = pos.coords.latitude;
                userLng = pos.coords.longitude;
                document.getElementById("location-display").textContent =
                    `Lat: ${userLat.toFixed(4)}, Lon: ${userLng.toFixed(4)}`;
            },
            err => {
                displayError("Location access denied.");
                document.getElementById("location-display").textContent = "Location access denied.";
            }
        );
    } else {
        displayError("Geolocation not supported by this browser.");
    }
};
</script>

</body>
</html>